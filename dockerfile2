# Use the latest version of Ubuntu as a base image
FROM ubuntu:latest

WORKDIR /external_repos

# Install necessary tools and dependencies for:
   ## zim-tools: git, meson, ninja-build, pkg-config, googletest, doxygen, libgumbo-dev, libmagic-dev
   ## docopt: git, python3-pip, python3-venv, python3-full, cmake, make
   ## libzim: git, meson, ninja-build, pkg-config, googletest, doxygen, liblzma-dev, libicu-dev, libzstd-dev, libxapian-dev
   ## Mustache: git, cmake, make, libboost-all-dev
    
RUN apt-get update && apt-get install -y \
        git \
        python3-pip \
        python3-venv \
        python3-full \
        cmake \
        make \
        meson \
        ninja-build \
        pkg-config \
        googletest \
        doxygen \
        liblzma-dev \
        libicu-dev \
        libzstd-dev \
        libxapian-dev \
        libboost-all-dev \
        libgumbo-dev \
        libmagic-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Clone the docopt repository and build (required by zim-tools) 
## It's a library for parsing command line options in Python.Is a C++ implementation.
RUN git clone https://github.com/docopt/docopt.cpp.git && \
    cd /external_repos/docopt.cpp && \
    cmake . && \
    make && \
    make install

# Create a virtual environment and install packages to build documentation
RUN python3 -m venv /opt/venv && \
    /bin/bash -c "source /opt/venv/bin/activate && pip install sphinx_rtd_theme breathe exhale"

# Clone the libzim repository and build it (required by zim-tools)
## It's a library used for reading and writing ZIM files.
RUN git clone https://github.com/openzim/libzim.git && \
    cd /external_repos/libzim && \
    meson . build && \
    ninja -C build && \
    ninja -C build install

# Clone the Mustache repository and build it (required by zim-tools) 
## Mustache is a logic-less template system.
RUN git clone https://github.com/kainjow/Mustache.git && \
    cd /external_repos/Mustache && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make && \
    cp ../mustache.hpp /usr/local/include/

# Clone the zim-tools repository and build it
## zim-tools are various tools to create, inspect and manipulate ZIM files (required by the project).
RUN git clone https://github.com/openzim/zim-tools.git && \
    cd /external_repos/zim-tools && \
    meson . build && \
    ninja -C build && \
    ninja -C build install